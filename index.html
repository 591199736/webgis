<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%">
<head>
  <meta charset="utf-8" />
  <meta content="initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
  <title>ArcGIS API for JavaScript Tutorials: Display a map</title>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      /*margin: auto;*/
    }
    .ifream1{
      display:block;
      border:none;
      height:100%;
      width:100%;
      overflow: hidden;
    }

  </style>

  <link href="https://js.arcgis.com/4.25/esri/themes/light/main.css" rel="stylesheet">
  <link href="css/index.css" rel="stylesheet">
  <script src="https://js.arcgis.com/4.25/"></script>
  <script src="./js/plagueCompany.js"></script>
  <script src="./js/jquery.js" type="text/javascript"></script>
  <!--script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5.4.1/dist/echarts.min.js"></script>不太理解为什么引入这个之后会出错-->
  <script>
    var Selecting;
    var ename=[];
    var temperature=[];
    var wealthy=[];
    var density=[];
    var population=[];
    var infected=[];
    var dead=[];
    var infeSpeed=[];
    var mediSpeed=[];
    var dieSpeed=[];
    var downfall=[];
    var tradeFriend1=[];
    var tradeFriend2=[];
    var tradeFriend3=[];
    var tradeFriend4=[];
    var neighbor;
    var na=[];
    //前端：选取初始国家，将该国家的infected[i]++，然后让game=1



    $.getJSON('data/Data.json', function (data1) {
      console.log("json文件数据", data1);
      for(i=0;i<206;i++){
        na[i]=data1.data[i].ename;
        infected[i]=Number(data1.data[i].infected);
        temperature[i]=Number(data1.data[i].Temperature);
        wealthy[i]=Number(data1.data[i].GDP);
        density[i]=Number(data1.data[i].pop_density);
        infeSpeed[i]=Number(data1.data[i].infect_speed);
        infeSpeed[i]=0.1;
        mediSpeed[i]=Number(data1.data[i].anti_speed);
        dieSpeed[i]=Number(data1.data[i].fatality_speed);
        downfall[i]=Number(data1.data[i].downfall);
        tradeFriend1[i]=Number(data1.data[i].trade1);
        tradeFriend2[i]=Number(data1.data[i].trade2);
        tradeFriend3[i]=Number(data1.data[i].trade3);
        tradeFriend4[i]=Number(data1.data[i].trade4);
        population[i]=Number(data1.data[i].population);
        //infected[i]=population[i];
        dead[i]=Number(data1.data[i].death);
        console.log("na"+i, na[i]);
      }

    });
    ename=na;
    $.getJSON('data/near.json', function (data2) {
      console.log("json文件数据", data2);
      neighbor=data2;
        console.log("neighbor", neighbor[0][1]);

    });
  </script>
  <script>
    require(["esri/config", "esri/Map", "esri/views/MapView","esri/views/SceneView","esri/layers/FeatureLayer","esri/widgets/Feature","esri/views/ui/DefaultUI","esri/core/promiseUtils"], function(esriConfig, Map, MapView,SceneView,FeatureLayer,Feature,DefaultUI,promiseUtils) {

      esriConfig.apiKey = "AAPK850ccb67284f4bb48e629a83a301529eQnTVfVtAZmL7wc7ah3t90KMXXYyRtz9RY3ya3sPnzxZ2fvttfWbvCs73IVub-fLE";

      const map = new Map({
        //basemap: "arcgis-topographic" // Basemap layer service
        basemap: "hybrid",
        ground: "world-elevation"
      });

      const view = new MapView({
        //const view = new SceneView({
        map: map,
        center: [118.805, 30], // Longitude, latitude
        maxBounds: [0, -90, 180, 90],
        zoom: 2, // Zoom level
        constraints: {
          geometry: {
            type: "extent",
            ymin: 10,
            ymax: 25,
            xmin: -9999,
            xmax:9999
          },
          minZoom: 2
        },
        renderWorldCopies: true,
        scrollZoom: false,
        container: "viewDiv", // Div element
        /*popup: {
          defaultPopupTemplateEnabled: false,
          // Dock the popup in the top right corner.
          dockEnabled: false
        },*/
        popup: {
            autoOpenEnabled: false
        }
        /*highlightOptions: {
            color: "#2dfff8"
        }*/
      });

      view.ui.empty("top-left");
      // Same value as the #sidebar width in CSS
      //view.padding.right = 320;


      // Add parks with a class breaks renderer and unique symbols
      //一个用来变色的函数
      function createFillSymbol(value,i) {
        const getRandomColor = color1(i)
        return {
          "value": value,
          "symbol": {
            "color": getRandomColor,//可以吧这噶地方变成数组？ 但是图层区分国家是用3-Digit ISO Code（是字母）或者Country Name,调用数组找到对应的颜色！
            "type": "simple-fill",
            "style": "solid",
            "outline": {
              "style": "none"
            }
          },
          "label": value
        };
      }

      function color1(i) {
        if(dead[i]===population[i]){
          return "rgb(110,110,110)";
        }else{
        const theColor=infected[i]/population[i];
        return "rgb(" + Math.round(theColor* 256) + "," + "0," + "0)";}
          //return "rgb(255,0,0)";}
      }
      //population = [];
      //var infected = new Array();
      //dead = [];
      //上面函数value的返回值对应颜色，之后好像应该改成连续条带,之后要改成对应每个国家的
      function rend() {
        return {
          type: "unique-value",
          field: "COUNTRY",
          uniqueValueInfos: [
            createFillSymbol(ename[0],0),
            createFillSymbol(ename[1],1),
            createFillSymbol(ename[2],2),
            createFillSymbol(ename[3],3),
            createFillSymbol(ename[4],4),
            createFillSymbol(ename[5],5),
            createFillSymbol(ename[6],6),
            createFillSymbol(ename[7],7),
            createFillSymbol(ename[8],8),
            createFillSymbol(ename[9],9),
            createFillSymbol(ename[10],10),
            createFillSymbol(ename[11],11),
            createFillSymbol(ename[12],12),
            createFillSymbol(ename[13],13),
            createFillSymbol(ename[14],14),
            createFillSymbol(ename[15],15),
            createFillSymbol(ename[16],16),
            createFillSymbol(ename[17],17),
            createFillSymbol(ename[18],18),
            createFillSymbol(ename[19],19),
            createFillSymbol(ename[20],20),
            createFillSymbol(ename[21],21),
            createFillSymbol(ename[22],22),
            createFillSymbol(ename[23],23),
            createFillSymbol(ename[24],24),
            createFillSymbol(ename[25],25),
            createFillSymbol(ename[26],26),
            createFillSymbol(ename[27],27),
            createFillSymbol(ename[28],28),
            createFillSymbol(ename[29],29),
            createFillSymbol(ename[30],30),
            createFillSymbol(ename[31],31),
            createFillSymbol(ename[32],32),
            createFillSymbol(ename[33],33),
            createFillSymbol(ename[34],34),
            createFillSymbol(ename[35],35),
            createFillSymbol(ename[36],36),
            createFillSymbol(ename[37],37),
            createFillSymbol(ename[38],38),
            createFillSymbol(ename[39],39),
            createFillSymbol(ename[40],40),
            createFillSymbol(ename[41],41),
            createFillSymbol(ename[42],42),
            createFillSymbol(ename[43],43),
            createFillSymbol(ename[44],44),
            createFillSymbol(ename[45],45),
            createFillSymbol(ename[46],46),
            createFillSymbol(ename[47],47),
            createFillSymbol(ename[48],48),
            createFillSymbol(ename[49],49),
            createFillSymbol(ename[50],50),
            createFillSymbol(ename[51],51),
            createFillSymbol(ename[52],52),
            createFillSymbol(ename[53],53),
            createFillSymbol(ename[54],54),
            createFillSymbol(ename[55],55),
            createFillSymbol(ename[56],56),
            createFillSymbol(ename[57],57),
            createFillSymbol(ename[58],58),
            createFillSymbol(ename[59],59),
            createFillSymbol(ename[60],60),
            createFillSymbol(ename[61],61),
            createFillSymbol(ename[62],62),
            createFillSymbol(ename[63],63),
            createFillSymbol(ename[64],64),
            createFillSymbol(ename[65],65),
            createFillSymbol(ename[66],66),
            createFillSymbol(ename[67],67),
            createFillSymbol(ename[68],68),
            createFillSymbol(ename[69],69),
            createFillSymbol(ename[70],70),
            createFillSymbol(ename[71],71),
            createFillSymbol(ename[72],72),
            createFillSymbol(ename[73],73),
            createFillSymbol(ename[74],74),
            createFillSymbol(ename[75],75),
            createFillSymbol(ename[76],76),
            createFillSymbol(ename[77],77),
            createFillSymbol(ename[78],78),
            createFillSymbol(ename[79],79),
            createFillSymbol(ename[80],80),
            createFillSymbol(ename[81],81),
            createFillSymbol(ename[82],82),
            createFillSymbol(ename[83],83),
            createFillSymbol(ename[84],84),
            createFillSymbol(ename[85],85),
            createFillSymbol(ename[86],86),
            createFillSymbol(ename[87],87),
            createFillSymbol(ename[88],88),
            createFillSymbol(ename[89],89),
            createFillSymbol(ename[90],90),
            createFillSymbol(ename[91],91),
            createFillSymbol(ename[92],92),
            createFillSymbol(ename[93],93),
            createFillSymbol(ename[94],94),
            createFillSymbol(ename[95],95),
            createFillSymbol(ename[96],96),
            createFillSymbol(ename[97],97),
            createFillSymbol(ename[98],98),
            createFillSymbol(ename[99],99),
            createFillSymbol(ename[100],100),
            createFillSymbol(ename[101],101),
            createFillSymbol(ename[102],102),
            createFillSymbol(ename[103],103),
            createFillSymbol(ename[104],104),
            createFillSymbol(ename[105],105),
            createFillSymbol(ename[106],106),
            createFillSymbol(ename[107],107),
            createFillSymbol(ename[108],108),
            createFillSymbol(ename[109],109),
            createFillSymbol(ename[110],110),
            createFillSymbol(ename[111],111),
            createFillSymbol(ename[112],112),
            createFillSymbol(ename[113],113),
            createFillSymbol(ename[114],114),
            createFillSymbol(ename[115],115),
            createFillSymbol(ename[116],116),
            createFillSymbol(ename[117],117),
            createFillSymbol(ename[118],118),
            createFillSymbol(ename[119],119),
            createFillSymbol(ename[120],120),
            createFillSymbol(ename[121],121),
            createFillSymbol(ename[122],122),
            createFillSymbol(ename[123],123),
            createFillSymbol(ename[124],124),
            createFillSymbol(ename[125],125),
            createFillSymbol(ename[126],126),
            createFillSymbol(ename[127],127),
            createFillSymbol(ename[128],128),
            createFillSymbol(ename[129],129),
            createFillSymbol(ename[130],130),
            createFillSymbol(ename[131],131),
            createFillSymbol(ename[132],132),
            createFillSymbol(ename[133],133),
            createFillSymbol(ename[134],134),
            createFillSymbol(ename[135],135),
            createFillSymbol(ename[136],136),
            createFillSymbol(ename[137],137),
            createFillSymbol(ename[138],138),
            createFillSymbol(ename[139],139),
            createFillSymbol(ename[140],140),
            createFillSymbol(ename[141],141),
            createFillSymbol(ename[142],142),
            createFillSymbol(ename[143],143),
            createFillSymbol(ename[144],144),
            createFillSymbol(ename[145],145),
            createFillSymbol(ename[146],146),
            createFillSymbol(ename[147],147),
            createFillSymbol(ename[148],148),
            createFillSymbol(ename[149],149),
            createFillSymbol(ename[150],150),
            createFillSymbol(ename[151],151),
            createFillSymbol(ename[152],152),
            createFillSymbol(ename[153],153),
            createFillSymbol(ename[154],154),
            createFillSymbol(ename[155],155),
            createFillSymbol(ename[156],156),
            createFillSymbol(ename[157],157),
            createFillSymbol(ename[158],158),
            createFillSymbol(ename[159],159),
            createFillSymbol(ename[160],160),
            createFillSymbol(ename[161],161),
            createFillSymbol(ename[162],162),
            createFillSymbol(ename[163],163),
            createFillSymbol(ename[164],164),
            createFillSymbol(ename[165],165),
            createFillSymbol(ename[166],166),
            createFillSymbol(ename[167],167),
            createFillSymbol(ename[168],168),
            createFillSymbol(ename[169],169),
            createFillSymbol(ename[170],170),
            createFillSymbol(ename[171],171),
            createFillSymbol(ename[172],172),
            createFillSymbol(ename[173],173),
            createFillSymbol(ename[174],174),
            createFillSymbol(ename[175],175),
            createFillSymbol(ename[176],176),
            createFillSymbol(ename[177],177),
            createFillSymbol(ename[178],178),
            createFillSymbol(ename[179],179),
            createFillSymbol(ename[180],180),
            createFillSymbol(ename[181],181),
            createFillSymbol(ename[182],182),
            createFillSymbol(ename[183],183),
            createFillSymbol(ename[184],184),
            createFillSymbol(ename[185],185),
            createFillSymbol(ename[186],186),
            createFillSymbol(ename[187],187),
            createFillSymbol(ename[188],188),
            createFillSymbol(ename[189],189),
            createFillSymbol(ename[190],190),
            createFillSymbol(ename[191],191),
            createFillSymbol(ename[192],192),
            createFillSymbol(ename[193],193),
            createFillSymbol(ename[194],194),
            createFillSymbol(ename[195],195),
            createFillSymbol(ename[196],196),
            createFillSymbol(ename[197],197),
            createFillSymbol(ename[198],198),
            createFillSymbol(ename[199],199),
            createFillSymbol(ename[200],200),
            createFillSymbol(ename[201],201),
            createFillSymbol(ename[202],202),
            createFillSymbol(ename[203],203),
            createFillSymbol(ename[204],204),
            createFillSymbol(ename[205],205),
          ]
        };
      }




      // Set the renderer on a layer
      var layer = new FeatureLayer({
        url: 'https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Countries/FeatureServer',
        //renderer: rend,//渲染
        opacity: 0.4,//透明度
        container: "feature-node",
        popupTemplate: {
          //content: "Mouse over features to show details...",
          title: "{COUNTRY}",}
      });

      // the layer will be refreshed every 6 seconds.
      map.add(layer);
      // layer.refreshInterval = 0.1;

      //document.getElementsByClassName("top-left-title").innerHTML=Selecting;
      // Update at 30fps
      setInterval(() => {
        //for(i=0;i<206;i++){const living=Math.random()*population[i];infected[i]=Math.random()*living;dead[i]=population[i]-living;}
        layer.renderer = rend();
        requestAnimationFrame(layer);
        if(mediPercent>0){confirm(mediPercent)}
        //confirm(DNApoint);
      }, 3000 );
      //如果需要条件判断可以用setTimeout+for循环

                  view.when().then(() => {
                      // Create a default graphic for when the application starts
                      const graphic = {
                          popupTemplate: {
                              //content: "Mouse over features to show details...",
                              title: "{COUNTRY}"
                          }
                      };

                      // Example: Listen to the click event on the view
                  // Provide graphic to a new instance of a Feature widget
                  const feature = new Feature({
                      container: "feature-node",
                      graphic: graphic,
                      map: view.map,
                      spatialReference: view.spatialReference
                  });

                  view.whenLayerView(layer).then((layerView) => {
                      let highlight;
                      let objectId;

                      const debouncedUpdate = promiseUtils.debounce((event) => {
                          // Perform a hitTest on the View
                          view.hitTest(event).then((event) => {
                              // Make sure graphic has a popupTemplate
                              const results = event.results.filter((result) => {
                                  return result.graphic.layer.popupTemplate;
                              });

                              const result = results[0];
                              const newObjectId =
                                  result && result.graphic.attributes[layer.objectIdField];

                              if (!newObjectId) {
                                  highlight && highlight.remove();
                                  objectId = feature.graphic = null;
                              } else if (objectId !== newObjectId) {
                                  highlight && highlight.remove();
                                  objectId = newObjectId;
                                  feature.graphic = result.graphic;
                                  highlight = layerView.highlight(result.graphic);
                              }
                          });
                      });
                      // Listen for the pointer-move event on the View
                      // and make sure that function is not invoked more
                      // than one at a time
                      view.on("click", (event) => {
                          debouncedUpdate(event).catch((err) => {
                              if (!promiseUtils.isAbortError(err)) {
                                  throw err;}
                          });
                        function selectName(){Selecting=$("#feature-node").text();}
                        selectName();
                        if(Selecting){//查询国家，更改饼图
                            document.getElementById("CountryName").innerHTML=Selecting+"感染情况";
                        } else{document . getElementById("CountryName").innerHTML="世界感染情况";}

                          setTimeout(function () {
                              selectName();
                              if(Selecting){//查询国家，更改饼图
                                if (game === 0) {
                                if (confirm("你将从" + Selecting + "开始游戏")) {
                                  t=ename.indexOf(Selecting);
                                  infected[t]=population[t]*0.01;
                                  game = 1;
                                  setInterval(() => {if(game==1){
                                    while(game==1) {
                                      main();
                                    }
                                  }},1000);
                                }}

                                document.getElementById("CountryName").innerHTML=Selecting+"感染情况";
                              } else{document . getElementById("CountryName").innerHTML="世界感染情况";
                              }
                          }, 1000);



                        //confirm("hi "+Selecting);
                      });
                  });
                  });
    })

  </script><!--这是地图的代码-->
  <script>
    //顶部时间
    function getTime(){
      var myDate = new Date();
      var myYear = myDate.getFullYear(); //获取完整的年份(4位,1970-????)
      var myMonth = myDate.getMonth()+1; //获取当前月份(0-11,0代表1月)
      var myToday = myDate.getDate(); //获取当前日(1-31)
      var myDay = myDate.getDay(); //获取当前星期X(0-6,0代表星期天)
      var myHour = myDate.getHours(); //获取当前小时数(0-23)
      var myMinute = myDate.getMinutes(); //获取当前分钟数(0-59)
      var mySecond = myDate.getSeconds(); //获取当前秒数(0-59)
      var week = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
      var nowTime;

      nowTime = year+'年'+fillZero(month)+'月'+fillZero(day)+'日'+'&nbsp;&nbsp;'+fillZero(myHour)+':'+fillZero(myMinute)+':'+fillZero(mySecond)+'&nbsp;&nbsp;'+week[myDay]+'&nbsp;&nbsp;';
      //console.log(nowTime);
      $('#time').html(nowTime);
    }
    function fillZero(str){
      var realNum;
      if(str<10){
        realNum	= '0'+str;
      }else{
        realNum	= str;
      }
      return realNum;
    }
    //大屏
    setInterval(getTime,1000);
  </script><!--这是那个时间的代码-->
</head>
<body>
<div class="header">
  <div class="header-left">
    <span>这是一个世界地图欸</span>
  </div>
  <div class="header-time">
    <span id="time"></span>
  </div>
</div>
<!--div class="">
    <div class="content-left"></div>
    <div id="viewDiv"></div>
</div-->
<div class="content">
  <div class="content-con">
    <div class="left-body" >
      <div class="left-top public-bg">
        <div class="public-title">DNA分配</div>
        <iframe class="ifream1" src="./html/bar.html"></iframe>
      </div>

      <div class="left-bottom public-bg">
        <div class="public-title" id="CountryName">世界感染情况</div>
        <iframe class="ifream1" src="./html/pie-simple.html"></iframe>
      </div>
    </div>

    <div class="center-body">
      <div id="viewDiv"></div>
    </div>

    <div class="right-body">
      <div class="right-top public-bg">
        <div class="public-title">国家感染情况排行（百分比）</div>
        <iframe src="./html/sort.html" class="ifream1"></iframe>
        <!--div id="sort"></div-->
      </div>
      <div class="right-bottom public-bg">
        <div class="public-title">解药研发进度</div>
        <iframe src="./html/progress.html" class="ifream1"></iframe>
        <div class="esri-widget" id="feature-node" style="background-color: rgba(13,50,95,0);color: white"></div>
      </div>
    </div>
  </div>
</div>
</body>
</html>